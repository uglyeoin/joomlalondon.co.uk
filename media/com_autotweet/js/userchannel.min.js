"use strict";define("userchannel",["extlycore","text!media/com_autotweet/js/userchannel/templates/enabled-channel.txt"],function(s,e){var r={onAuthMailchannel:function(e){return this.msg=null,this.authParams=e,!0},onAuthFbchannel:function(e,n){return this.msg=null,this.authParams=e,this.pendingView=n,window.fbAsyncInit?this._fbAssignToken():this._fbInit(),null},_fbInit:function(){var e,n,t,i,s;window.fbAsyncInit=function(){FB.init({appId:r.authParams.app_id,xfbml:!0,cookie:!0,version:"v2.8"}),r._fbAssignToken()},e=document,n="script",t="facebook-jssdk",s=e.getElementsByTagName(n)[0],e.getElementById(t)||((i=e.createElement(n)).id=t,i.src="//connect.facebook.com/en_US/sdk.js",s.parentNode.insertBefore(i,s))},_fbAssignToken:function(){FB.login(function(e){e.authResponse?FB.getLoginStatus(function(e){"connected"===e.status?(r.authParams.access_token=e.authResponse.accessToken,r.pendingView.authorizedChannel()):r.onAuthFbchannel(r.authParams,r.pendingView)}):alert("User cancelled login or did not fully authorize.")},{scope:"public_profile,publish_actions"})},onAuthTwchannel:function(e){this.msg=null,window.location=e.request_token_url},onAuthLichannel:function(e){this.msg=null,window.location=e.request_token_url},onAuthLioauth2channel:function(e){this.msg=null,window.location=e.request_token_url},onAuthLigroupchannel:function(e){this.msg=null,window.location=e.request_token_url},getStatusMessage:function(){return this.msg},getAuthParams:function(){return this.authParams},showError:function(e,n){n?(e.$("#alert-msg").removeClass("hide"),e.$("#error-msg").html(n)):e.$("#alert-msg").addClass("hide")}},n=(s.ExtlyModel.extend({url:function(){return s.SefHelper.route("index.php?option=com_autotweet&view=userchannels&task=authorizeAction")}}),s.ExtlyModel.extend({url:function(){return s.SefHelper.route("index.php?option=com_autotweet&view=userchannels&task=addAuthChannel")}})),t=s.ExtlyModel.extend({url:function(){return s.SefHelper.route("index.php?option=com_autotweet&view=userchannels&task=getAuthParams")}}),i=s.ExtlyModel.extend({url:function(){return s.SefHelper.route("index.php?option=com_autotweet&view=userchannels&task=publishAction")}}),a=s.ExtlyModel.extend({url:function(){return s.SefHelper.route("index.php?option=com_autotweet&view=userchannels&task=unpublishAction")}}),o=Backbone.Collection.extend({model:n}),l=Backbone.Collection.extend({model:t}),u=Backbone.View.extend({tagName:"tr",template:_.template(e),events:{"click a.publish":"onPublish","click a.unpublish":"onUnpublish"},initialize:function(){},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this.$el.addClass("enabled-channel success"),this},onPublish:function(e){return this.lastEvent=e,this.attributes.eventsHub.trigger("userChannel:re-authorize",{channelId:this.attributes.channelId,channelView:this}),e.preventDefault(),!1},onReAuthorized:function(){var e=new i;return this.executeAction(this.lastEvent.currentTarget,e)},onUnpublish:function(e){var n=new a;return e.preventDefault(),this.executeAction(e.currentTarget,n)},executeAction:function(e,n){var i=this;return i.attributes.spinner.addClass("loading"),r.showError(i,null),n.fetch({data:{_token:i.attributes.token,channelId:i.attributes.channelId,authParams:r.getAuthParams()},wait:!0,dataType:"text",success:function(e,n,t){i.attributes.spinner.removeClass("loading"),e.get("status")?(i.model=e,i.render()):r.showError(i,e)},error:function(e,n,t){i.attributes.spinner.removeClass("loading"),r.showError(i,n.responseText)}}),!1}}),h=Backbone.View.extend({initialize:function(){this.attributes.eventsHub.on("userChannel:authorized",this.addAuthChannel,this),this.$enabledList=this.$("#enabledList"),this.collection.on("add",this.addOne,this),this.token=this.$("#XTtoken").attr("name"),this.spinner=this.$(".loaderspinner"),this.initializeSubviews()},addAuthChannel:function(){var i=this;return i.spinner.addClass("loading"),r.showError(i,null),this.collection.create(this.collection.model,{attrs:{authParams:r.getAuthParams(),token:i.token},wait:!0,dataType:"text",success:function(e,n,t){i.spinner.removeClass("loading"),e.get("status")||r.showError(i,e||"Unknown error (EnabledView)")},error:function(e,n,t){i.spinner.removeClass("loading"),r.showError(i,n.responseText)}}),!1},addOne:function(e){var n;if(!e.get("status"))return!1;n=new u({model:e,attributes:{channelId:e.get("id"),token:this.token,spinner:this.spinner,eventsHub:this.attributes.eventsHub}}),this.$enabledList.removeClass("hide"),this.$enabledList.append(n.render().el)},initializeSubviews:function(e){var n,t=this,i=t.$("tr.enabled-channel");_.each(i,function(e){n=t.$(e).find(".channel_id").val(),new u({el:e,model:new s.ExtlyModel,attributes:{channelId:n,token:t.token,spinner:t.spinner,eventsHub:t.attributes.eventsHub}})})}}),c=Backbone.View.extend({events:{"click a.authorize-pending":"onAuthorize"},initialize:function(){jQuery("#F0FHeaderHolder").hide(),this.attributes.eventsHub.on("userChannel:re-authorize",this.onReAuthorize,this),this.token=this.$("#XTtoken").attr("name"),this.spinner=this.$(".loaderspinner"),this.$pendingChannel=null},onAuthorize:function(e){var n,t;return e.preventDefault(),n=this.$(e.currentTarget),this.$pendingChannel=n.parents(".pending-channel"),t=this.$pendingChannel.find(".channeltype_id").val(),this.spinner.addClass("loading"),r.showError(this,null),this.collection.create(this.collection.model,this.getAuthParamsCallback(this,{attrs:{channelTypeId:t,token:this.token}})),!1},getAuthParamsCallback:function(o,e){var n={wait:!0,dataType:"text",success:function(e,n,t){var i,s,a;o.spinner.removeClass("loading"),e.get("status")?(a=e.get("callback"),s=e.get("params"),!0===(i=r[a](s,o))?o.authorizedChannel():!1===i&&r.showError(o,r.getStatusMessage()||"Unknown error (PendingView 2)")):r.showError(o,e||"Unknown error (PendingView)")},error:function(e,n,t){r.showError(o,n.responseText)}};return _.extend(n,e)},authorizedChannel:function(){this.$pendingChannel?(this.$pendingChannel.remove(),this.$pendingChannel=null,this.$("#no-auth-channels-msg").remove(),this.attributes.eventsHub.trigger("userChannel:authorized")):(this.channelView.onReAuthorized(),this.channelView=null)},onReAuthorize:function(e){var n=new this.collection.model;this.channelView=e.channelView,n.save(null,this.getAuthParamsCallback(this,{attrs:{channelId:e.channelId,token:this.token}}))},showError:function(e,n){n?(e.$("#alert-msg").removeClass("hide"),e.$("#error-msg").html(n)):e.$("#alert-msg").addClass("hide")}}),d=_.clone(Backbone.Events);new c({el:jQuery("#adminForm"),collection:new l,attributes:{eventsHub:d}}),new h({el:jQuery("#adminForm"),collection:new o,attributes:{eventsHub:d}})});
