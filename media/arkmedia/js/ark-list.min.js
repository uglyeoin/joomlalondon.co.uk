(function(n){var t=function(n){this.initialise(n)};t.prototype=n.extend({},n.fn.arkbase(),{constructor:t,options:{css:{selected:"selected",back:{value:"back",css:".back"},preview:".folder .image",folder:".folder",file:".file",control:"[data-stack]",view:"[data-view]",path:"[data-stack-control]",select:"[data-select]",edit:"[data-edit]",bubble:"[data-select] [data-bubble]",action:"[data-action]",actions:{skip:{value:"skip",css:"[data-skip]"},check:{value:"check",css:'[data-action="check"]'},edit:{value:"edit",css:'[data-action="edit"]'},copy:{value:"copy",css:'[data-action="copy"]'},move:{value:"move",css:'[data-action="move"]'},remove:{value:"remove",css:'[data-action="remove"]'},rename:{value:"rename",css:'[data-action="rename"]',parent:".rename"},save:{value:"save",css:'[data-action="save"]'},cancel:{value:"cancel",css:'[data-action="cancel"]'}},form:{form:"#form-list",stack:"#form-list-stack",path:"#form-list-path",item:"#form-list-item",action:"#form-list-action",extra:"#form-list-extra"},templates:{root:"#tmpl-content",stack:"#tmpl-content-%s-stack",back:"#tmpl-content-%s-back",folder:"#tmpl-content-%s-folder",file:"#tmpl-content-%s-file",actions:"#tmpl-content-%s-actions",preview:"#tmpl-content-%s-folderpreview"}},data:{view:"data-view",path:"data-path",select:"data-select",skip:"data-skip",action:"data-action",nu:{value:"new",data:"data-new"},old:{value:"old",data:"data-old"}},html:{move:"New Path:",ajax:"&ajax=1",messages:{removeconfirm:"Proceed?",renamepartial:"Complete!"},errors:{invalidpath:"Invalid Path!",renameerror:"Rename Failed!",renameempty:"No Name!",renamesame:"No Change!"}},namespace:".list",confirm:{remove:!0}},el:{root:null,content:null,stacks:null,form:{}},initialise:function(t){if(this.set(t),this.el.root=n(this.options.css.root),this.el.content=this.el.root.find(this.options.css.content),this.el.stacks=this.el.content.find(this.options.css.stack),this.el.form.form=this.el.root.find(this.options.css.form.form),this.el.form.form&&(this.el.form.stack=this.el.form.form.find(this.options.css.form.stack),this.el.form.path=this.el.form.form.find(this.options.css.form.path),this.el.form.item=this.el.form.form.find(this.options.css.form.item),this.el.form.action=this.el.form.form.find(this.options.css.form.action),this.el.form.extra=this.el.form.form.find(this.options.css.form.extra)),n.views){if(!this.el.stacks.length)return this.debug("initialise","No Breadcrumb Stacks"),!1}else return this.message("Dependent Classes Not Found"),this.debug("initialise","Dependent Classes Not Found"),!1;this.assets();this.register();this.requests()},assets:function(){n(document).trigger("arklist:before:assets");var t=this;n.views.helpers({getContentTemplate:function(i){return i=i?i:"root",t.options.css.templates.hasOwnProperty(i)?n.templates(t.options.css.templates[i].replace(t.options.html.sprintf,this.ctx.root.view)):null},fileTooltip:function(n,t){return t?"<strong>"+n+"<\/strong><br/> "+t.x+" x "+t.y:"<strong>"+n+"<\/strong>"},rename:function(i,r){var s=i.target,f=n(i.target).parents(t.options.css.actions.rename.parent),h=n(i.target).data(t.options.data.key.value),o=r.oldValue,c=r.value,u,e;return s&&f.length?(u=f.find(t.options.css.actions.save.css),e=f.find(t.options.css.actions.cancel.css),u&&e?(u.data(t.options.data.key.value,h),u.data(t.options.data.old.value,o),u.data(t.options.data.nu.value,c),e.data(t.options.data.old.value,o)):t.debug("assets","Rename Save/Cancel Button Missing.")):t.debug("assets","Required Rename Elements Missing, Continuing Will Fail."),!1}},n.templates(this.options.css.templates.root));n.views.tags({svg:function(t){var i=!1,r=!1;return(n.each(t,n.proxy(function(t,u){if(n.type(u.size)=="object")return i=u,r=this.tagCtx.props.folder+"-"+Math.random().toString(16).slice(2),!1},this)),i)?this.tagCtx.render({id:r,name:i.name}):""},back:{render:function(){var n=this.ctx.root.active.path,i=n?n.substr(0,n.lastIndexOf(t.options.html.ds)):"";return this.tagCtx.render({back:i})},linked:!1,onAfterLink:function(){this.linked||(n.observe(this.ctx.root.active,"path",n.proxy(function(){this.disposed||this.refresh()},this)),this.linked=!0)}},rename:{render:function(){return typeof this.rename=="undefined"&&(this.rename={active:!1},n.observable(this.rename)),this.tagCtx.render({rename:this.rename})},onAfterLink:function(){this.contents().on("click"+t.options.namespace,t.options.css.actions.rename.css,n.proxy(function(){return t.permission("ark.action.rename")?(n.observable(this.rename).setProperty("active",!0),!1):(t.message(t.options.html.errors.permission,"error",{wink:"slow"}),t.debug("action","The User Does Not Have Sufficient Privileges to Rename a File."),!1)},this));this.contents().on("click"+t.options.namespace,t.options.css.actions.save.css+","+t.options.css.actions.cancel.css,n.proxy(function(i){var r=n(i.target),s=r.data(t.options.data.key.value),f=r.data(t.options.data.old.value),u=r.data(t.options.data.nu.value);if(r.attr(t.options.data.action)==t.options.css.actions.save.value)if(f&&!u)t.message(t.options.html.errors.renameempty,"warning"),t.debug("assets","The Rename Action Failed Due to the Name Being Empty.");else if(f!=u&&f&&u){var e=n(document).triggerHandler("observer:request:active",{type:"stack"}),o=n(document).triggerHandler("observer:request:active",{type:"path",stack:e.value}),h={stack:e.value,active:o,ajax:!0,name:f,extra:u,action:t.options.css.actions.rename.value};result=t.action(r,h);result.status?(n(document).triggerHandler("observer:request:rename",{type:"file",stack:e.value,path:o.path,oldname:s,newname:u}),result.messages&&result.messages.length?n.each(result.messages,function(n,i){t.message(i.message,i.type?i.type:"info")}):t.message(t.options.html.messages.renamepartial,"success"),t.debug("assets","The Rename Action Was Successfully Executed.","info")):(result.messages&&result.messages.length?n.each(result.messages,function(n,i){t.message(i.message,i.type?i.type:"info")}):t.message(t.options.html.errors.renameerror),t.debug("assets","The Rename Action Failed During the Action Logic/Ajax Call."))}else t.message(t.options.html.errors.renamesame,"warning"),t.debug("assets","The Rename Action Failed Due to the Name Not Being Altered.");else t.message(t.options.html.errors.cancel,"info"),t.debug("assets","The Rename Action Was Cancelled by the User or Insufficient Data Found on the Action Button.");return n.observable(this.rename).setProperty("active",!1),!1},this))}}});n(document).trigger("arklist:after:assets")},register:function(){n(document).trigger("arklist:before:register");var t=n(document).triggerHandler("observer:request:all"),i=n.templates(this.options.css.templates.root);i?this.el.stacks.each(n.proxy(function(r,u){var f=n(u).attr(this.options.data.stack),o=t[f].path,e=n(document).triggerHandler("observer:request:active",{type:"path",stack:f}),s=n(document).triggerHandler("observer:request:active",{type:"folders",stack:f}),h=n(document).triggerHandler("observer:request:active",{type:"files",stack:f});n(u).find(this.options.css.view).each(n.proxy(function(r,u){var s=n(u).attr(this.options.data.view);n(u).link(i,{stack:t[f].items,name:f,view:s,base:o,active:e})},this));this.links(u,{stack:f,active:e,folders:s,files:h})},this)):this.debug("register","Could Not Find Template");n(document).trigger("arklist:after:register")},links:function(t,i){n(t).on("click"+this.options.namespace,this.options.css.select,{options:this.options},function(t){n(this).toggleClass(t.data.options.css.selected);var r=n(this).attr(t.data.options.data.path)?"folders":"files";n(document).triggerHandler("observer:request:active",{type:r,stack:i.stack,value:n(this).attr(t.data.options.data.select)})});n(t).on("dblclick"+this.options.namespace,this.options.css.path,{options:this.options},function(t){n(document).triggerHandler("observer:request:active",{type:"path",stack:i.stack,value:n(this).attr(t.data.options.data.path)})});n(t).on("singleTap"+this.options.namespace,this.options.css.path,{options:this.options},function(){n(this).trigger("dblclick")});n(t).on("doubleTap"+this.options.namespace,this.options.css.folder,{options:this.options},function(){n(this).trigger("click")});n(t).on("dblclick"+this.options.namespace,this.options.css.edit,{edit:this.options.data.edit.value,path:i.active},function(t){n(document).triggerHandler("edit:request:file",{file:n(this).data(t.data.edit),stack:i.stack,path:t.data.path.path})});n(t).on("doubleTap"+this.options.namespace,this.options.css.edit,function(){n(this).trigger("dblclick")});n(t).on("click"+this.options.namespace,this.options.css.bubble,function(n){n.stopPropagation()});n(t).on("click"+this.options.namespace,this.options.css.action,{self:this},function(n){n.data.self.action(this,i)});n(t).on("tap"+this.options.namespace,this.options.css.action,function(){n(this).trigger("click")});n.observe(i.folders,i.files,n.proxy(function(){this.select(t,i.folders,i.files)},this))},requests:function(){n(document).on("list:request:actions",n.proxy(function(n,t){if(t&&typeof t=="object"){if(t.action==="data")return this.options.data.action;if(this.options.css.actions.hasOwnProperty(t.action))return this.options.css.actions[t.action]}return this.options.css.actions},this))},select:function(t,i,r){n(document).trigger("arklist:before:select",[t,i,r]);n(t).find(this.options.css.select).each(n.proxy(function(t,u){var f=n(u).attr(this.options.data.path)?i:r;n.inArray(n(u).attr(this.options.data.select),f)!=-1?n(u).addClass(this.options.css.selected):n(u).removeClass(this.options.css.selected)},this));n(document).trigger("arklist:after:select",[t,i,r])},action:function(t,i){var o,f,s;if(i=n.extend(n(document).triggerHandler("list:before:action",{form:this.el.form,el:t,options:n.extend({},i)}),i),i.skip||n(t).attr(this.options.data.skip))return!1;var u=i.name||n(t).attr(this.options.data.name),r=i.action||n(t).attr(this.options.data.action),e=!0;if(n.each(this.el.form,n.proxy(function(t,i){if(!i||!n(i).get(0))return this.message(this.options.html.errors.form),this.debug("action","Some of the SubAction Form Elements Are Missing."),e=!1},this)),e)if(i.stack&&i.active.path)if(u&&r){if(this.options.css.actions.hasOwnProperty(r)&&!this.permission("ark.action."+r))return this.message(this.options.html.errors.permission,"error",{wink:"slow"}),this.debug("action",'The User Does Not Have Sufficient Privileges to Perform the "'+r+'" Action.'),!1;this.el.form.stack.val(i.stack);this.el.form.path.val(i.active.path);this.el.form.item.val(u);switch(r){default:return this.message(this.options.html.errors.action),this.debug("action","The Action Does Not Exist/Not Plumbed in."),!1;case this.options.css.actions.check.value:return!1;case this.options.css.actions.edit.value:return this.options.version.pro?(this.message(this.options.html.messages.feature.plugin,"info",{wink:"slow"}),this.debug("action","The Edit Action is Disabled.")):(this.message(this.options.html.messages.feature.upgrade,"info",{wink:"slow"}),this.debug("action","The Edit Action is a Professional Only Feature.")),!1;case this.options.css.actions.copy.value:this.el.form.action.val(this.options.css.actions.copy.value);break;case this.options.css.actions.move.value:if(o=this.prompt(this.options.html.move,this.el.form.path.val(),i.stack),!o)return!1;this.el.form.extra.val(o);this.el.form.action.val(this.options.css.actions.move.value);break;case this.options.css.actions.remove.value:if(f=this.options.html.messages.removeconfirm.replace(this.options.html.sprintf,u),this.options.confirm.remove&&!confirm(f))return this.message(this.options.html.errors.cancel,"info"),this.debug("action","Delete Process Not Confirmed by User."),!1;this.el.form.action.val(this.options.css.actions.remove.value);break;case this.options.css.actions.rename.value:if(!i.extra)return!1;this.el.form.extra.val(i.extra);this.el.form.action.val(this.options.css.actions.rename.value)}if(i.ajax)return this.ajaxAction();this.el.form.form.submit()}else f=this.options.html.errors.action,s=u?"The Action Could Not be Found on the Element.":"The File Name Could Not be Found on the Element.",this.message(f),this.debug("action",s);else this.message(this.options.html.errors.path),this.debug("action","The Observer Active Stack Path Could Not be Found.");else this.message(this.options.html.errors.form),this.debug("action","Some of the SubAction Form Elements Are Missing.");n(document).trigger("list:after:action",{form:this.el.form,el:t,options:i})},prompt:function(t,i,r){var u=prompt(t,i);if(n.type(u)=="null")return this.message(this.options.html.errors.cancel,"info"),this.debug("action","The Move Action Was Cancelled by the User.","info"),!1;if(u){if(!n(document).triggerHandler("observer:request:validate",{type:"path",stack:r,value:u}))return this.message(this.options.html.errors.invalidpath,"alert"),this.debug("action","The Path Does Not Exist or is Not in the Stack."),this.prompt(t,u,r)}else return this.message(this.options.html.errors.path,"alert"),this.debug("action","The Path Entered by the User is Empty."),this.prompt(t,i,r);return u},ajaxAction:function(t){n(document).trigger("arklist:before:ajax",[this.el.form]);t=t||{};var i=this,r={status:!1,messages:[]},u=t.async||!1;return n.ajax({type:"post",dataType:"json",async:u,url:this.el.form.form.attr("action")+this.options.html.ajax,data:this.el.form.form.serialize()}).done(function(n){n&&typeof n=="object"?(r=n,n.status||i.debug("ajaxAction","Rename Ajax Call Returned a Failed Status.")):i.debug("ajaxAction","Rename Ajax Call Returned Malformed Data.")}).fail(function(){i.debug("ajaxAction","Rename Ajax Call Failed.")}),n.each(r.messages,function(n,t){t.type=t.type==="message"?"success":t.type}),n(document).trigger("arklist:after:ajax",[this.el.form]),r}});n.fn.list=function(n){return new t(n)}})(window.jQuery)