(function(n){var t=function(n){this.initialise(n)};t.prototype=n.extend({},n.fn.arkbase(),{constructor:t,options:{css:{contenttopbar:"#ark-contenttop",editbar:"#ark-editbar",actionbar:"#ark-actions",subactionbar:"#ark-subactions",editactionbar:"#ark-edit-actions",preview:{container:"#ark-edit-preview",holder:".preview",preview:"*",loading:".loading",failed:".failed"},settings:{container:"#ark-edit-settings",fieldset:".fieldset",group:".row",field:".field",lists:"select",combos:"div.combobox",stacks:"[data-stack]"},action:"[data-action]",actions:{save:{value:"save",css:'[data-action="save"]'},exit:{value:"exit",css:'[data-action="exit"]'},cancel:{value:"cancel",css:'[data-action="cancel"]'},browse:{value:"browse",css:'[data-action="browse"]'},insert:{value:"insert",css:'[data-action="insert"]'}},templates:{root:"#tmpl-edit",actions:"#tmpl-edit-actions",preview:"#tmpl-edit-preview",settings:"#tmpl-edit-settings",subactions:"#tmpl-edit-subactions"}},data:{wild:"*",group:"data-customgroup",action:"data-action"},html:{messages:{save:"Saved!"},errors:{nofile:"No File!",noparent:"No Parent!",filelost:"No File!"}},namespace:".edit",enabled:!0,wait:!1,quick:!1,edit:{editor:null,field:null,stack:null,path:null,file:null,callback:null},xml:{},permission:{insert:null,settings:null},animate:1e3},el:{root:null,contenttop:null,editbar:null,actions:null,subactions:null,editactions:null,content:null,edit:null,preview:null,settings:null,lists:null,combos:null,stacks:null,controls:null},initialise:function(t){if(this.set(t),this.el.root=n(this.options.css.root),this.el.contenttop=this.el.root.find(this.options.css.contenttopbar),this.el.editbar=this.el.root.find(this.options.css.editbar),this.el.actions=this.el.root.find(this.options.css.actionbar),this.el.subactions=this.el.root.find(this.options.css.subactionbar),this.el.content=this.el.root.find(this.options.css.content),this.el.edit=this.el.root.find(this.options.css.editbox),!n.views)return this.message("Dependent Classes Not Found"),this.debug("initialise","Dependent Classes Not Found"),!1;if(this.requests(),!this.options.enabled)return this.debug("initialise",'"Edit Mode" is Disabled.',"info"),!1;this.loader();this.assets();this.setDefault()},loader:function(){n(document).trigger("arkedit:before:loader");n(document).on("edit:request:file",n.proxy(function(t,i){if(i.file){if(i.stack&&i.path&&(n(document).triggerHandler("observer:request:active",{type:"stack",value:i.stack}),n(document).triggerHandler("observer:request:active",{type:"path",stack:i.stack,value:i.path})),n(document).triggerHandler("observer:request:active",{type:"edit",value:i.file}),this.options.quick)return n(document).triggerHandler("edit:request:save"),!0;if(this.el.content.length&&this.el.edit.length){var r=n(document).triggerHandler("observer:request:active",{type:"stack"});return n(document).triggerHandler("observer:request:active",{type:"files",stack:r.value,value:[]}),this.el.contenttop.slideUp(this.options.animate),this.el.content.slideUp(this.options.animate,n.proxy(function(){this.el.editbar.slideDown(this.options.animate);this.el.actions.slideUp(this.options.animate);this.el.subactions.slideUp(this.options.animate);this.register();this.elements();this.addEditEvents();this.el.edit.slideDown(this.options.animate)},this)),!0}}else this.message(this.options.html.errors.data,"error",{wink:"slower"}),this.debug("loader","Insufficient File Data Provided for the Edit Mode to Intiate.");return!1},this));n(document).on("edit:request:save",n.proxy(function(n){var t=this.insert(n);return t?(this.message(this.options.html.messages.save,"success"),this.debug("loader","Edit Mode Saved & Exited.","info"),window.close(),!0):!1},this));n(document).on("edit:request:exit",n.proxy(function(){return window.close()},this));n(document).on("edit:request:close",n.proxy(function(n){return this.unload(n)?(this.message(this.options.html.errors.cancel,"info"),this.debug("loader","Edit Mode Cancelled by User.","info"),!0):!1},this));n(document).on("edit:request:browse",n.proxy(function(n){return this.unload(n)?(this.debug("loader","Edit Mode Closed by User.","info"),!0):!1},this));n(document).on("edit:request:preview:open",n.proxy(function(){var t=this.el.preview.find(this.options.css.preview.holder),i=this.el.preview.find(this.options.css.preview.loading);i.slideUp(this.options.animate,n.proxy(function(){t.slideDown(this.options.animate)},this))},this));n(document).on("edit:request:preview:close",n.proxy(function(){var t=this.el.preview.find(this.options.css.preview.failed),i=this.el.preview.find(this.options.css.preview.loading);i.slideUp(this.options.animate,n.proxy(function(){t.slideDown(this.options.animate)},this))},this));n(document).trigger("arkedit:after:loader")},requests:function(){n(document).on("edit:request:params",n.proxy(function(){return this.options.edit},this));n(document).on("edit:request:state",n.proxy(function(){return this.options.enabled},this))},assets:function(){n(document).trigger("arkedit:before:assets");var t=this;n.views.helpers({getTemplate:function(i){return t.options.css.templates.hasOwnProperty(i)?n.templates(t.options.css.templates[i]):null},preview:function(i){var r;if(i){var u=n(document).triggerHandler("observer:request:active",{type:"stack"}),f=n(document).triggerHandler("observer:request:active",{type:"path",stack:u.value}),e=t.toURL(t.options.html.url+f.path+t.options.html.ds+i),o={stack:u.value,path:e,name:i};r=n(document).triggerHandler("edit:request:preview:html",o)||"";r||(r=n("<span>").addClass(t.options.css.hide.value).get(0).outerHTML,n(document).delay(0).queue(function(n){if(t.el.preview){var i=t.el.preview.find(t.options.css.preview.holder);i.find(t.options.css.preview.preview).trigger("error")}n()}))}return r},icon:function(t){var i=n(document).triggerHandler("observer:request:active",{type:"stack"}),r=n(document).triggerHandler("edit:request:icon",{stack:i.value});return r||t}},n.templates(this.options.css.templates.root));n.views.converters({defaults:function(t){var i=this.linkCtx?n(this.linkCtx.elem).val():"";return t||i||""},listdefaults:function(i){var r=n(this.linkCtx.elem);if(n.type(i)==="array"&&r.is("select")){var f=r.find("option"),e=n.map(f,function(n){return n.value}),u=r;r.find("optgroup").length&&($group=n('<optgroup label="'+(r.attr(t.options.data.group)||"")+'"><\/optgroup>'),r.append($group),u=$group);n.each(i,function(t,i){n.inArray(i,e)===-1&&u.append("<option>"+i+"<\/option>")})}return this.linkCtx.view.getRsc("converters","defaults").call(this,i)}},n.templates(this.options.css.templates.root));typeof n.fn.callable!="function"&&(n.fn.callable=n.proxy(function(n){return this.isCallable(n)},this));typeof n.fn.attributes!="function"&&(n.fn.attribs=n.proxy(function(t){var i={};return n.each(t.attributes,function(n,t){i[t.name]=t.value}),i},this));n(document).trigger("arkedit:after:assets")},setDefault:function(){if(n(document).trigger("arkedit:before:default",[this.options.edit]),this.options.edit.stack&&this.options.edit.path&&this.options.edit.file){var t=n(document).triggerHandler("observer:request:validate",{type:"path",stack:this.options.edit.stack,value:this.options.edit.path}),i=n(document).triggerHandler("observer:request:validate",{type:"file",stack:this.options.edit.stack,path:this.options.edit.path,value:this.options.edit.file});n(document).triggerHandler("stack:request:solo");t?i?this.options.wait||this.options.quick?this.options.quick&&this.highlight("file",this.options.edit.stack,this.options.edit.path,this.options.edit.file):n(document).triggerHandler("edit:request:file",{file:this.options.edit.file,stack:this.options.edit.stack,path:this.options.edit.path}):(this.message(this.options.html.errors.nofile,"error",{wink:"slower"}),this.debug("setDefault","The Stack Information is Available but the Passed File Does not Exist in the Stack Path.")):(this.message(this.options.html.errors.invalid,"error",{wink:"slower"}),this.debug("setDefault","The Passed Stack & Path Data is Invalid."))}else this.options.edit.stack&&this.options.edit.editor?n(document).triggerHandler("stack:request:solo"):this.options.edit.file&&(this.message(this.options.html.errors.path,"error",{wink:"slower"}),this.debug("setDefault","The Passed Stack & Path Data is Incomplete/Missing."));n(document).trigger("arkedit:after:default",[this.options.edit])},register:function(){var t;if(n(document).trigger("arkedit:before:register"),t=n.templates(this.options.css.templates.root),t){var i=n(document).triggerHandler("observer:request:active",{type:"stack"}),r=n(document).triggerHandler("observer:request:active",{type:"path",stack:i.value}),u=n(document).triggerHandler("observer:request:active",{type:"edit"}),f=this.attributes(i.value);try{n(this.el.edit).link(t,{path:r,file:u,info:f})}catch(e){this.debug("register",'Register Failed With: "'+e.message+'"')}}else this.debug("register","Could Not Find Template");n(document).trigger("arkedit:after:register")},elements:function(){n(document).trigger("edit:before:elements",[this.el]);this.el.editactions=this.el.edit.find(this.options.css.editactionbar);this.el.controls=this.el.edit.find(this.options.css.action);this.el.preview=this.el.edit.find(this.options.css.preview.container);this.el.settings=this.el.edit.find(this.options.css.settings.container);this.el.fieldsets=this.el.settings.find(this.options.css.settings.fieldset);this.el.groups=this.el.settings.find(this.options.css.settings.group);this.el.lists=this.el.settings.find(this.options.css.settings.lists);this.el.combos=this.el.settings.find(this.options.css.settings.combos);this.el.stacks=this.el.settings.find(this.options.css.settings.stacks);n(document).trigger("edit:after:elements",[this.el])},addEditEvents:function(){var t,i,r;n(document).trigger("arkedit:before:event");t=n(document).triggerHandler("observer:request:active",{type:"stack"});n.fn.chosen&&(this.el.lists.chosen({disable_search_threshold:10,width:"100%"}),this.el.lists.each(n.proxy(function(t,i){var r=n(i).data(this.options.data.value.value);r&&(n(i).val(r),n(i).trigger("liszt:updated"),n(i).trigger("chosen:updated"))},this)));n.fn.ComboTransform&&this.el.combos.ComboTransform({updateList:!0});this.el.controls.on("click"+this.options.namespace,{options:this.options},function(t){switch(n(this).attr(t.data.options.data.action)){case t.data.options.css.actions.exit.value:n(document).triggerHandler("edit:request:exit");break;case t.data.options.css.actions.cancel.value:n(document).triggerHandler("edit:request:close");break;case t.data.options.css.actions.save.value:n(document).triggerHandler("edit:request:save");break;case t.data.options.css.actions.browse.value:n(document).triggerHandler("edit:request:browse");break;case t.data.options.css.actions.insert.value:n(document).triggerHandler("edit:request:save")}});if(this.el.stacks.each(n.proxy(function(i,r){var u=n(r).attr(this.options.data.stack),f=n(r).find(this.options.css.settings.field);u&&u!=t.value&&(n(r).addClass(this.options.css.hide.value),f&&f.prop("disabled",!0))},this)),this.el.fieldsets.each(n.proxy(function(t,i){var u=n(i).find(this.options.css.settings.group),r=!0;u.each(n.proxy(function(t,i){n(i).hasClass(this.options.css.hide.value)||(r=!1)},this));r&&n(i).addClass(this.options.css.hide.value)},this)),this.el.editactions.find(this.options.css.stack).each(n.proxy(function(i,r){var u=n(r).attr(this.options.data.stack);u&&u!=t.value&&n(r).addClass(this.options.css.hide.value)},this)),this.el.preview.length){i=n(document).triggerHandler("edit:request:preview:event",{stack:t.value})||"load";r=this.el.preview.find(this.options.css.preview.holder);r.find(this.options.css.preview.preview).on(i+this.options.namespace,n.proxy(function(){n(document).triggerHandler("edit:request:preview:open")},this)).on("error"+this.options.namespace,n.proxy(function(){n(document).triggerHandler("edit:request:preview:close")},this))}n(document).trigger("arkedit:after:event",[this.el.lists,this.el.controls])},insert:function(t){var f=n(document).triggerHandler("arkedit:before:insert",{caller:t}),r,u;if(f&&f.isImmediatePropagationStopped())return!1;var e=this.isCallable(this.options.edit.callback),o=!1,i=n(document).triggerHandler("observer:request:active",{type:"stack"}),s=n(document).triggerHandler("observer:request:active",{type:"path",stack:i.value}),h=n(document).triggerHandler("observer:request:active",{type:"edit"}),c=this.toURL(s.path+this.options.html.ds+h.value);return e?(r={},this.permission(this.options.permission.settings)&&!this.options.quick&&(r=this.form(i.value)),u=n(document).triggerHandler("edit:request:build",{stack:i.value,options:this.options.edit,attributes:r,path:c}),u?(e[this.options.edit.callback](u,this.options.edit.field),o=!0):(this.message(this.options.html.errors.filelost,"error",{wink:"slow"}),this.debug("insert","Either The Parent Window Could not be Found or Reference to the Original Editor File Was Lost."))):(this.message(this.options.html.errors.noparent,"error",{wink:"slow"}),this.debug("insert",'Either The Parent Window Could not be Found or the "Insert" Function Could not be Called.')),n(document).trigger("arkedit:after:insert"),o},unload:function(t){var i=n(document).triggerHandler("arkedit:before:unload",{caller:t});return i&&i.isImmediatePropagationStopped()?!1:this.el.content.length&&this.el.edit.length?(this.el.editbar.slideUp(this.options.animate),this.el.edit.slideUp(this.options.animate,n.proxy(function(){n(document).triggerHandler("observer:request:active",{type:"edit",value:null});this.el.contenttop.slideDown(this.options.animate);this.el.actions.slideDown(this.options.animate);this.el.subactions.slideDown(this.options.animate);this.el.content.slideDown(this.options.animate);this.el.edit.empty()},this)),!0):(n(document).trigger("arkedit:after:unload"),!1)},isCallable:function(t){return(n(document).trigger("arkedit:before:callable"),window.opener&&(!t||t&&typeof window.opener[t]=="function"))?window.opener:(n(document).trigger("arkedit:after:callable"),!1)},attributes:function(t){var r=n(document).triggerHandler("edit:request:attributes",{stack:t,options:this.options.edit}),i={};return r&&n.each(this.options.xml,n.proxy(function(u,f){var o=r.hasOwnProperty(f.attribute)?r[f.attribute]:!1,e,s;if(o||f.attribute.indexOf(this.options.data.wild)!==-1){i[f.fieldname]="";switch(f.converter){case"full":i[f.fieldname]=o;break;case"list-regex":case"list-full":e=[];n.each(f.options,function(n,t){t&&o.indexOf(t)!==-1&&e.push(t)});switch(e.length){case 0:break;case 1:i[f.fieldname]=e.shift();break;default:i[f.fieldname]=e.reduce(function(n,t){return n.length>t.length?n:t})}break;case"attr-regex":e=[];s=this.toArray(f.omissions);n.each(r,n.proxy(function(t,i){if(t.indexOf(f.attribute.replace(this.options.data.wild,""))===0&&n.inArray(t,s)===-1){var r=i?t+'="'+i+'"':t;e.push(r)}},this));e.length&&(i[f.fieldname]=e);break;default:i[f.fieldname]=n(document).triggerHandler("edit:request:converter",{stack:t.value,field:f,attribute:o})}}},this)),i},form:function(t){var r=this.fields(this.el.settings,{groups:!1}),i=n(document).triggerHandler("edit:request:attributes",{stack:t,options:this.options.edit}),u=n.extend({},this.options.xml);return i&&(n.each(u,function(n,f){if(!f.stack||f.stack&&f.stack===t)switch(f.converter){case"full":i[f.attribute]=r[f.fieldname];delete u[n]}}),n.each(u,n.proxy(function(u,f){var e,o,s;if(!f.stack||f.stack&&f.stack===t){e=r[f.attribute]||"";switch(f.converter){case"list-regex":n.each(f.options,n.proxy(function(n,t){if(t&&e.indexOf(t)!==-1){var i="(^|"+f.separator+")"+this.escape(t)+"+(?=$|"+f.separator+")";e=e.replace(new RegExp(i,"g"),"")}},this));o=this.trim(e,f.separator);i[f.attribute]=(o?o+f.separator:"")+r[f.fieldname];break;case"list-full":n.each(f.options,n.proxy(function(n,t){t&&e.indexOf(t)!==-1&&(e=e.replace(t,""))},this));o=this.trim(e,f.separator);i[f.attribute]=(o?o+f.separator:"")+r[f.fieldname];break;case"attr-regex":n.each(i,n.proxy(function(n){n.indexOf(f.attribute.replace(this.options.data.wild,""))===0&&(i[n]="")},this));s=(typeof r[u]=="string"?[r[u]]:r[u])||[];n.each(s,function(n,t){var r=t.split('="');i[r[0]]=r[1]?r[1].replace('"',""):""});break;default:i[f.attribute]=n(document).triggerHandler("edit:request:unconverter",{stack:t,field:f,attribute:e})}r[f.attribute]=i[f.attribute]}},this))),i}});n.fn.edit=function(n){return new t(n)}})(window.jQuery)