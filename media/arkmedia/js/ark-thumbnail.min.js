(function(n){var t=function(n){this.initialise(n)};t.prototype=n.extend({},n.fn.arkbase(),{constructor:t,options:{css:{content:"#ark-content",stack:"[data-stack]",view:"[data-view]",thumbnail:"[data-thumbnail]",container:"[data-container]",loading:".loading",names:{loading:"loading",failed:"failed"}},data:{view:"data-view",thumbnail:"data-thumbnail",path:"data-path",file:"data-file",size:"data-size",target:"data-target"},html:{icon:"icon-",ajax:"index.php",unknown:"unknown"},namespace:".thumbnail",batch:5,refresh:!1,cache:!0},separator:".",tmp:[],extra:null,el:{root:null,content:null,stacks:null,thumbnails:{queue:null,pending:null,processed:null}},initialise:function(t){this.set(t);this.el.root=n(this.options.css.root);this.el.content=this.el.root.find(this.options.css.content);this.el.stacks=this.el.content.find(this.options.css.stack);this.el.thumbnails.queue=this.el.content.find(this.options.css.thumbnail);this.el.thumbnails.pending={};this.el.thumbnails.processed={};this.refresh();this.process();this.register();this.requests()},process:function(){n(document).trigger("arkthumbnail:before:process");this.extra=n(document).triggerHandler("edit:request:params");this.el.thumbnails.queue.each(n.proxy(function(t,i){var r=this.key(i),f=this.cache(r),e=r.split(this.separator)[0],u;f?this.render(i,f):(u={stack:e,key:r},n.each(this.options.data,function(t,r){typeof r=="string"&&n(i).attr(r)&&(u[t]=n(i).attr(r))}),this.tmp.push(u),this.el.thumbnails.pending[r]=i,(t+1)%this.options.batch&&this.el.thumbnails.queue.length!=t+1||(this.fire(),this.tmp=[]))},this));n(document).trigger("arkthumbnail:after:process",[this.el.thumbnails])},fire:function(){if(n(document).trigger("arkthumbnail:before:fire",[this.tmp]),this.options.html.ajax&&this.tmp.length){var t=this,i=this.extra;i.thumbs=this.tmp;n.ajax({type:"post",dataType:"json",url:this.options.html.ajax,items:this.tmp,data:i}).done(function(i){i&&i.length?n.each(i,function(n,i){var r=t.el.thumbnails.pending[i.key];delete t.el.thumbnails.pending[i.key];t.el.thumbnails.processed[i.key]=r;r&&i.key&&i.path?(t.cache(i.key,i.path),t.render(r,i.path)):r?(t.state(r,"failed"),t.debug("fire","Thumbnail Could Not be Loaded.")):i.key&&t.el.thumbnails.processed.hasOwnProperty(i.key)?t.debug("fire",'Thumbnail: "'+i.path+'" Has Already Been Loaded.',"info"):t.debug("fire",'Thumbnail: "'+i.key+'" Could Not be Loaded.')}):(n.each(this.items,function(n,i){t.el.thumbnails.pending.hasOwnProperty(i.key)&&(t.state(t.el.thumbnails.pending[i.key],"failed"),t.el.thumbnails.processed[i.key]=t.el.thumbnails.pending[i.key],delete t.el.thumbnails.pending[i.key])}),t.debug("fire","Thumbnails Could Not be Loaded."))}).fail(function(){n.each(this.items,function(n,i){t.el.thumbnails.pending.hasOwnProperty(i.key)&&(t.state(t.el.thumbnails.pending[i.key],"failed"),t.el.thumbnails.processed[i.key]=t.el.thumbnails.pending[i.key],delete t.el.thumbnails.pending[i.key])});t.debug("fire","Failed to Retrieve Thumbnails.")})}else this.debug("fire","Invalid Information Required to Load Thumbnails.");n(document).trigger("arkthumbnail:after:fire",[this.tmp])},render:function(t,i){var r,u,f;n(document).trigger("arkthumbnail:before:render",[t,i]);this.state(t,"rendering");switch(n(t).attr(this.options.data.thumbnail)){default:case"all":i.indexOf(this.options.html.icon)===0&&n(t).attr(this.options.data.target)=="src"&&(r=n("<i>",{"data-target":"class",id:n(t).attr("id")}).addClass(i).addClass(n(t).attr("class")),u=["thumbnail","link"],r.attr("title",n(t).attr("title")),n.each(n(t).data(),n.proxy(function(t,i){n.inArray(t,u)===-1&&n.type(i)==="string"&&r.attr(this.options.data.data+t,i)},this)),n(t).replaceWith(r),t=r);break;case"thumbnail":break;case"icon":}f=n(t).attr(this.options.data.target)?n(t).attr(this.options.data.target):"src";n(t).attr(f,i);n(document).trigger("arkthumbnail:after:render",[t,i])},state:function(t,i){if(n(document).trigger("arkthumbnail:before:status",[t,i]),t&&i){var r=n(t).closest(this.options.css.container);switch(i){case"rendering":n(t).removeClass(this.options.css.names.loading);r.length&&n(r).removeClass(this.options.css.names.loading);break;case"failed":n(t).addClass(this.options.css.names.failed).removeClass(this.options.css.names.loading);r.length&&n(r).addClass(this.options.css.names.failed).removeClass(this.options.css.names.loading)}}n(document).trigger("arkthumbnail:after:status",[t,i])},cache:function(t,i){if(n(document).trigger("arkthumbnail:before:cache",[t,i]),!this.options.cache)return!1;if(t)if(typeof sessionStorage!="undefined")try{return i&&(sessionStorage[t]=i),sessionStorage[t]}catch(r){this.debug("cache","Unable to Store Path")}else this.debug("cache","Session Storage Not Supported");else this.debug("cache","Invalid Information Required to Temporarily Store the Thumbnail");n(document).trigger("arkthumbnail:after:cache",[t,i])},refresh:function(){this.options.refresh&&this.clear()},rename:function(t,i){if(n(document).trigger("arkthumbnail:before:rename",[t]),t&&i)if(typeof sessionStorage!="undefined")try{sessionStorage.setItem(i,sessionStorage.getItem(t));sessionStorage.removeItem(t)}catch(r){this.debug("rename",'Unable to Rename Thumbnail Cache Key From "'+t+'" to "'+i+'"')}else this.debug("rename","Session Storage Not Supported");else this.debug("rename",'Unable to Rename Thumbnail Cache Key From "'+t+'" to "'+i+'"');n(document).trigger("arkthumbnail:after:rename",[t])},register:function(){n(document).trigger("arkthumbnail:before:register");var t=n(document).triggerHandler("observer:request:all");this.el.stacks.each(n.proxy(function(t,i){var r=n(i).attr(this.options.data.stack),u=n(document).triggerHandler("observer:request:active",{type:"path",stack:r});this.links(i,{i:t,active:u})},this));n(document).trigger("arkthumbnail:after:register")},links:function(t,i){if(n.observe(i.active,"path",function(){window.setTimeout(function(){n(document).triggerHandler("thumbnail:request:requeue",{element:t})},0)}),!i.i)n(document).on("observer:request:rename",n.proxy(function(t,i){if(i.type==="file"){var r=this.search(i.stack,null,i.path,i.oldname);n.each(r,n.proxy(function(n,t){this.rename(t,t.replace(this.separator+i.oldname,this.separator+i.newname))},this))}},this))},requests:function(){n(document).on("thumbnail:request:requeue",n.proxy(function(t,i){i.force&&n(document).triggerHandler("thumbnail:request:clear",i);this.el.thumbnails.queue=n(i.element).find(this.options.css.thumbnail);this.process()},this));n(document).on("thumbnail:request:clear",n.proxy(function(t,i){var r=[];i.element&&n(i.element).find(this.options.css.thumbnail).each(n.proxy(function(n,t){r.push(this.key(t))},this));this.clear(r)},this))},key:function(t){var i=n(t).attr(this.options.data.stack),r=n(t).parents(this.options.css.view).attr(this.options.data.view),u=n(t).attr(this.options.data.path),f=n(t).attr(this.options.data.file);return i||(i=n(t).parents(this.options.css.stack).attr(this.options.data.stack)),this._key(i,r,u,f)},_key:function(n,t,i,r,u){var f=[];return f.push(n?n:this.options.html.unknown),f.push(t?t:this.options.html.unknown),f.push(i?i:this.options.html.unknown),f.push(r?r:this.options.html.unknown),f.join(u?u:this.separator)},search:function(n,t,i,r){var n="("+(n&&n.length&&n!==this.options.html.unknown?this.escape(n):"[\\S]+")+")",t="("+(t&&t.length&&t!==this.options.html.unknown?this.escape(t):"[\\S]+")+")",i="("+(i&&i.length&&i!==this.options.html.unknown?this.escape(i):"[\\S]+")+")",r="("+(r&&r.length&&r!==this.options.html.unknown?this.escape(r):"[\\S]+")+")",e=this._key(n,t,i,r,"\\"+this.separator),f=[],u;if(typeof sessionStorage!="undefined")try{for(u=0;u<sessionStorage.length;u++)sessionStorage.key(u).match(new RegExp(e,"ig"))&&f.push(sessionStorage.key(u))}catch(o){this.debug("find","Unable to Search for Cached Thumbnail Keys")}else this.debug("find","Session Storage Not Supported");return f},clear:function(t){if(typeof sessionStorage!="undefined")try{t&&t.length?n.each(t,function(n,t){sessionStorage.getItem(t)&&sessionStorage.removeItem(t)}):sessionStorage.clear()}catch(i){this.debug("refresh","Unable to Clear Cache")}else this.debug("refresh","Session Storage Not Supported")}});n.fn.thumbnail=function(n){return new t(n)}})(window.jQuery)