(function(n){var t=function(n){this.initialise(n)};t.prototype=n.extend({},n.fn.arkbase(),{constructor:t,options:{html:{ajax:{item:"index.php"},errors:{malform:"Error!",fail:"Error!",ajax:"No Data!"}},namespace:".observer",stacks:{},defaults:{path:null}},active:{stack:{value:null},paths:{},folders:{},files:{},edit:{value:null}},queue:0,edit:null,initialise:function(t){if(this.set(t),!n.views)return this.message("Dependent Classes Not Found"),this.debug("initialise","Dependent Classes Not Found"),!1;this.store();this.assets();this.requests();this.defaults()},store:function(){n(document).trigger("observer:before:register",[this.options.stacks]);n.each(this.options.stacks,n.proxy(function(t,i){this.active.paths[t]=n.observable({path:i.path});this.active.folders[t]=n.observable([]);this.active.files[t]=n.observable([])},this));this.active.stack=n.observable(this.active.stack);this.active.edit=n.observable(this.active.edit);this.options.stacks=n.observable(this.options.stacks);n(document).trigger("observer:after:register",[this.options.stacks])},assets:function(){n(document).trigger("arkobserver:before:assets");var t=this;n.views.helpers({isChildFolder:function(n,i,r){var u=new RegExp(t.escape(t.options.html.ds+i)+"$");return n!=r&&n.replace(u,"")==r?!0:!1},bytes:function(t,i,r){var t=t,i=i?i:"auto",r=r?parseInt(r):2,f=["B","KB","MB","GB","TB","PB"],u,e;return t?(u=Math.floor(Math.log(t)/Math.log(1024)),i!=="auto"&&n.inArray(i,f)!=-1&&(u=n.inArray(i,f)),e=t/Math.pow(1024,u),parseFloat(e.toFixed(r))+" "+f[u]):0},date:function(n,i,r){return(i=typeof i!="undefined"?i:t.options.html.date,r=typeof r!="undefined"?r:t.options.html.blank,typeof moment=="function"&&n&&n!=="0"&&i)?moment.unix(n).format(i):r},previous:function(n,t){return t[n-1]},next:function(n,t){return t[n+1]}});n.views.tags({reverse:function(t){var i=[];return n.each(t,n.proxy(function(n,t){t.data&&t.events||i.push(this.tagCtx.render(t))},this)),i.reverse().join("\n")},alphabetise:function(t){var i=[];return n.each(t,n.proxy(function(n,t){t.data&&t.events||i.push({key:n,item:t})},this)),i=i.sort(function(n,t){return n.key>t.key?1:-1}),n.map(i,n.proxy(function(n,t){return this.tagCtx.render({i:t,key:n.key,item:n.item})},this)).join("\n")},chronologise:function(t){var i=[],r=this.tagCtx.props.index||null,u=this.tagCtx.props.direction||"asc";return n.each(t,n.proxy(function(n,t){t.data&&t.events||i.push({key:t[r],item:t})},this)),r&&(i=i.sort(function(n,t){return u=="asc"?n.key>t.key?1:-1:n.key<t.key?1:-1})),n.map(i,n.proxy(function(n,t){return this.tagCtx.render({i:t,key:n.key,items:i,item:n.item})},this)).join("\n")},debug:function(n){var t=this.tagCtx.props,i=t.message||"Debug: ";console.log(i,n)}});n(document).trigger("arkobserver:after:assets")},requests:function(){n(document).on("observer:request:all",n.proxy(function(){return this.options.stacks.data()},this));n(document).on("observer:request:item",n.proxy(function(n,t){var i=this.options.stacks.data(),r,u;if(t.stack&&t.path&&i.hasOwnProperty(t.stack))switch(t.type){case"folder":if(r=t.item?t.path+this.options.html.ds+t.item:t.path,i[t.stack].items.hasOwnProperty(r))return u=i[t.stack].items[r],t.load&&!u.loaded&&this.item(t.stack,r),u;break;case"file":if(t.item&&i[t.stack].items.hasOwnProperty(t.path)&&i[t.stack].items[t.path].items.hasOwnProperty(t.item))return i[t.stack].items[t.path].items[t.item]}return!1},this));n(document).on("observer:request:load",n.proxy(function(t,i){var r=this.options.stacks.data();if(i.stack&&i.path&&r.hasOwnProperty(i.stack)){var u=i.item?i.path+this.options.html.ds+i.item:i.path,o={branch:i.branch?i.branch:!0},f={name:"observer:request:loaded",options:i.options?i.options:{}},e=r[i.stack].items.hasOwnProperty(u)?r[i.stack].items[u]:!1;e&&e.loaded?n(document).triggerHandler(f.name,f.options):this.item(i.stack,u,o,f)}},this));n(document).on("observer:request:active",n.proxy(function(t,i){var r;switch(i.type){default:case"stack":return i.value&&this.active.stack.setProperty("value",i.value),this.active.stack.data();case"path":if(this.active.paths.hasOwnProperty(i.stack)){if(i.value&&i.value!=this.active.paths[i.stack].data().path){var u=n(document).triggerHandler("observer:request:item",{type:"folder",stack:i.stack,path:i.value}),f={branch:i.branch?i.branch:!1},e={name:"observer:request:active",options:{type:"path",stack:i.stack,value:i.value}};u&&u.loaded?(this.active.folders[i.stack].refresh([]),this.active.files[i.stack].refresh([]),this.active.paths[i.stack].setProperty("path",i.value)):this.item(i.stack,i.value,f,e)}return this.active.paths[i.stack].data()}return i.stack=="all"?this.active.paths:"";case"folders":return this.active.folders.hasOwnProperty(i.stack)?(i.value&&(n.isArray(i.value)?this.active.folders[i.stack].refresh(i.value):(r=n.inArray(i.value,this.active.folders[i.stack].data()),r===-1?this.active.folders[i.stack].insert(i.value):this.active.folders[i.stack].remove(r))),this.active.folders[i.stack].data()):"";case"files":return this.active.files.hasOwnProperty(i.stack)?(i.value&&(n.isArray(i.value)?this.active.files[i.stack].refresh(i.value):(r=n.inArray(i.value,this.active.files[i.stack].data()),r===-1?this.active.files[i.stack].insert(i.value):this.active.files[i.stack].remove(r))),this.active.files[i.stack].data()):"";case"edit":return(i.value||n.type(i.value)==="null")&&this.active.edit.setProperty("value",i.value),this.active.edit.data()}},this));n(document).on("observer:request:validate",n.proxy(function(t,i){var u,r,f;switch(i.type){default:case"stack":return this.options.stacks.data().hasOwnProperty(i.value);case"path":return u=i.value.replace(/^(\/|\s)+/,"").replace(/(\/|\s)+$/,""),r=this.options.stacks.data(),r.hasOwnProperty(i.stack)&&r[i.stack].items.hasOwnProperty(u);case"basepath":return r=this.options.stacks.data(),r.hasOwnProperty(i.stack)&&i.value.indexOf(r[i.stack].path)===0;case"file":return(r=this.options.stacks.data(),f=n(document).triggerHandler("observer:request:key",{value:i.value}),!n(document).triggerHandler("observer:request:validate",{type:"path",stack:i.stack,value:i.path}))?!1:r[i.stack].items[i.path].items.hasOwnProperty(f)}},this));n(document).on("observer:request:rename",n.proxy(function(t,i){switch(i.type){case"title":return this.options.stacks.data().hasOwnProperty(i.stack)?(this.options.stacks.setProperty(i.stack+".title",i.value),!0):!1;case"subtitle":return this.options.stacks.data().hasOwnProperty(i.stack)?(this.options.stacks.setProperty(i.stack+".subtitle",i.value),!0):!1;case"folder":return!1;case"file":return n.observable(this.options.stacks.data()[i.stack].items[i.path].items[i.oldname]).setProperty("name",i.newname),!0}return!1},this));n(document).on("observer:request:update",n.proxy(function(t,i){var r,u;switch(i.type){case"folder":return r=i.item?i.path+this.options.html.ds+i.item:i.path,n.observable(this.options.stacks.data()[i.stack].items[r]).setProperty(i.key,i.value),!0;case"file":return u=n(document).triggerHandler("observer:request:key",{value:i.item}),n.observable(this.options.stacks.data()[i.stack].items[i.path].items[u]).setProperty(i.key,i.value),!0}return!1},this));n(document).on("observer:request:key",n.proxy(function(n,t){return t.value.replace(/\./g,"")},this));n(document).on("observer:request:add",n.proxy(function(t,i){if(i.type&&i.stack&&i.path&&i.item)switch(i.type){case"folder":return n.observable(this.options.stacks.data()[i.stack].items).setProperty(i.path,i.item),!0;case"file":return i.name&&this.options.stacks.data()[i.stack].items.hasOwnProperty(i.path)?(n.observable(this.options.stacks.data()[i.stack].items[i.path].items).setProperty(i.name,i.item),!0):!1}return!1},this))},defaults:function(){n(document).trigger("observer:before:defaults");this.options.defaults.stack&&this.options.defaults.path&&window.setTimeout(n.proxy(function(){jQuery(document).triggerHandler("observer:request:active",{type:"path",stack:this.options.defaults.stack,value:this.options.defaults.path})},this),50);n(document).trigger("observer:after:defaults")},item:function(t,i,r,u){var r,u,a;if(n(document).trigger("observer:before:item",[t,i,r]),this.options.html.ajax.item&&t&&i)if(typeof r=="undefined"&&(r={}),typeof u=="undefined"&&(u=!1),this.edit||(this.edit=n(document).triggerHandler("edit:request:params")),r.branch=r.branch?r.branch:!1,r.branch){var v=i.split(this.options.html.ds),h=[],c="",o={},f="",l=!1,e=u,s="observer:internal:item."+n.guid;if(r.branch=!1,e){n(document).on(s,n.proxy(function(t,i){i.i===this.queue&&(window.setTimeout(function(){n(document).triggerHandler(i.callback,i.options)},0),n(document).off(s),this.queue=0)},this));a={i:this.queue,callback:e.name,options:e.options?e.options:{}};u={name:s,options:a}}while(c=v.shift())h.push(c),f=h.join(this.options.html.ds),o=n(document).triggerHandler("observer:request:item",{type:"folder",stack:t,path:f,load:!1}),l=n(document).triggerHandler("observer:request:validate",{type:"basepath",stack:t,value:f}),!l||o&&o.loaded||(u&&(this.queue++,u.options.i=this.queue),this._item(t,f,r,u))}else this._item(t,i,r,u);else this.message(this.options.html.errors.ajax,"error",{wink:"slower"}),this.debug("item","Item Failed as the Necessary Data Could Not Found.");n(document).trigger("observer:after:item",[t,i,r])},_item:function(t,i,r,u){var f=this,e=this.edit;e.stack=t;e.path=i;e.branch=+r.branch;n.ajax({type:"post",dataType:"json",url:this.options.html.ajax.item,callback:u,data:e}).done(function(r){r&&typeof r=="object"&&r.hasOwnProperty(i)?(n.each(r,function(u,f){var e=n(document).triggerHandler("observer:request:item",{type:"folder",stack:t,path:u,load:!1});e?e.loaded||n.each(r[u],function(r,u){r==="items"?n.each(u,function(r,u){n(document).triggerHandler("observer:request:add",{type:"file",stack:t,path:i,name:r,item:u})}):n(document).triggerHandler("observer:request:update",{type:"folder",stack:t,path:i,key:r,value:u})}):n(document).triggerHandler("observer:request:add",{type:"folder",stack:t,path:u,item:f})}),this.callback&&this.callback.name&&this.callback.options&&n(document).triggerHandler(this.callback.name,this.callback.options)):(f.message(f.options.html.errors.malform,"error",{wink:"slower"}),f.debug("item","Item Ajax Call Returned Malformed Data."))}).fail(function(){f.message(f.options.html.errors.fail,"error",{wink:"slower"});f.debug("item","Item Ajax Call Failed.")})}});n.fn.observer=function(n){return new t(n)}})(window.jQuery)