(function(n){var t=function(n){this.initialise(n)};t.prototype=n.extend({},n.fn.arkbase(),{constructor:t,options:{css:{explorer:"#ark-explorer",overlay:".overlay",selected:"selected",folder:".folder",file:".file",toggle:".toggle",path:"[data-stack-control]",select:"[data-select]",templates:{root:"#tmpl-explorer",tree:"#tmpl-explorer-tree"}},data:{control:"data-stack-control",path:"data-path",select:"data-select"},html:{},namespace:".explorer",scroll:{all:"",one:""},root:!0},el:{root:null,explorer:null,overlay:null,stacks:{}},initialise:function(t){if(this.set(t),this.el.root=n(this.options.css.root),this.el.explorer=this.el.root.find(this.options.css.explorer),this.el.overlay=this.el.explorer.find(this.options.css.overlay),n.each(this.el.explorer.find(this.options.css.stack),n.proxy(function(t,i){this.el.stacks[n(i).attr(this.options.data.stack)]=i},this)),n.views){if(n.isEmptyObject(this.el.stacks))return this.debug("initialise","No Explorer Stacks"),!1}else return this.message("Dependent Classes Not Found"),this.debug("initialise","Dependent Classes Not Found"),!1;this.assets();this.register();this.requests()},assets:function(){n(document).trigger("arkexplorer:before:assets");var t=this;n.views.helpers({canRenderFolder:function(){return this.ctx.isinit&&!this.ctx.root.showroot?!1:!0},isAutoExpanded:function(){return this.ctx.isinit&&!this.ctx.root.showroot?!0:!1}});n.views.tags({tree:{init:function(i){i.view.data.key&&(i.view.data.path=i.view.data.key);this.data=i.view.data;this.data.isinit=i.props.init;this.data.showroot=t.options.root;this.data.paths=this.ctx.root.paths;this.data.isinit&&n(document).triggerHandler("observer:request:update",{type:"folder",stack:this.data.name,path:this.data.path,key:"expanded",value:!0})},onAfterLink:function(){},template:t.options.css.templates.tree,dataBoundOnly:!0}});n(document).trigger("arkexplorer:after:assets")},register:function(){n(document).trigger("arkexplorer:before:register");var t=n(document).triggerHandler("observer:request:all"),i=n.templates(this.options.css.templates.root);i?n.each(this.el.stacks,n.proxy(function(r,u){var f=n(document).triggerHandler("observer:request:active",{type:"path",stack:r}),e=n(document).triggerHandler("observer:request:active",{type:"folders",stack:r}),o=n(document).triggerHandler("observer:request:active",{type:"files",stack:r}),s=n(document).triggerHandler("observer:request:active",{type:"edit"});n(u).link(i,{name:r,stack:t[r].items,path:t[r].path,active:f});this.links(u,{stack:r,folders:e,files:o,active:f,file:s})},this)):this.debug("register","Could Not Find Template");n(document).trigger("arkexplorer:after:register")},links:function(t,i){var r=this;n(t).on("click"+this.options.namespace,this.options.css.path,function(){n(document).triggerHandler("observer:request:active",{type:"path",stack:i.stack,value:n(this).attr(r.options.data.path)})});n(t).on("click"+this.options.namespace,this.options.css.toggle,{options:this.options},function(t,u){var f=n(this).attr(t.data.options.data.path),e=u&&u.direction?u.direction:"";r.expand(i.stack,f,e)});n(t).on("dblclick"+this.options.namespace,this.options.css.edit,{edit:this.options.data.edit.value,path:i.active},function(t){n(document).triggerHandler("edit:request:file",{file:n(this).data(t.data.edit),stack:i.stack,path:t.data.path.path})});n(t).on("click"+this.options.namespace,this.options.css.select+this.options.css.file,function(){var t=n(this).attr(r.options.data.path);t&&t!=i.active.path&&n(document).triggerHandler("observer:request:active",{type:"path",stack:i.stack,value:t});n(this).toggleClass(r.options.css.selected);n(document).triggerHandler("observer:request:active",{type:"files",stack:i.stack,value:n(this).attr(r.options.data.select)})});n.observe(i.folders,n.proxy(function(n){this.select(i.stack,i.active.path,n.target,"folders")},this));n.observe(i.files,n.proxy(function(n){this.select(i.stack,i.active.path,n.target,"files")},this));n.observe(i.active,"path",n.proxy(function(){this.open(i.stack,i.active.path)},this));n.observe(i.file,"*",n.proxy(function(n){n.target.value?this.el.overlay.fadeIn():this.el.overlay.fadeOut()},this))},requests:function(){n(document).on("explorer:request:rescroll",n.proxy(function(t,i){var r;(this.options.scroll.all||this.options.scroll.one)&&(r=typeof i=="object"&&i.stack?n(this.options.scroll.one.replace(this.options.html.sprintf,i.stack)):n(this.options.scroll.all),r.nanoScroller())},this));n(document).on("explorer:request:scroll",n.proxy(function(){},this))},select:function(t,i,r,u){var f=u=="files"?this.options.css.select+this.options.css.file:this.options.css.select+this.options.css.path;n(this.el.stacks[t]).find(f).each(n.proxy(function(t,f){var e=n(f).attr(this.options.data.path),o=u=="folders"?e.replace(this.options.html.ds+n(f).attr(this.options.data.select),""):e,o=u=="folders"&&e==i?"":o;o==i&&(n.inArray(n(f).attr(this.options.data.select),r)!=-1?n(f).addClass(this.options.css.selected):n(f).removeClass(this.options.css.selected))},this))},open:function(t,i,r){r=n.isArray(r)?r:[];n(this.el.stacks[t]).find(this.options.css.path).each(n.proxy(function(u,f){var e=n(f).attr(this.options.data.path),o,s;n.inArray(e,r)===-1&&i.indexOf(e)===0&&(r.push(e),o=n(f).parents(this.options.css.folder).get(0),s=o?n(o).find(this.options.css.toggle):!1,s&&(n(s).trigger("click",{direction:"open"}),e!=i&&this.open(t,i,r)))},this))},expand:function(t,i,r){var f=n(document).triggerHandler("observer:request:item",{type:"folder",stack:t,path:i,load:!0}),u=typeof f.expanded!="undefined"?f.expanded:!1;if((!r||(r!=="open"||!u)&&(r!=="close"||u))&&(n(document).triggerHandler("observer:request:update",{type:"folder",stack:t,path:i,key:"expanded",value:!u}),n(document).triggerHandler("explorer:request:rescroll",{stack:t}),!u)){var o=n(document).triggerHandler("observer:request:active",{type:"folders",stack:t}),s=n(document).triggerHandler("observer:request:active",{type:"files",stack:t}),e=n(document).triggerHandler("observer:request:active",{type:"path",stack:t});this.select(t,e.path,o,"folders");this.select(t,e.path,s,"files")}}});n.fn.explorer=function(n){return new t(n)}})(window.jQuery)